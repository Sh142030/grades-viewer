<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <title>نظام إدارة الدرجات - جمعية بناء</title>
    <!-- Bootstrap RTL -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css">
    <!-- React -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel -->
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- كل المكونات في نفس الملف -->
    <script type="text/babel">
        // مكون الترويسة
        function Header() {
            return (
                <header className="bg-dark text-light p-3 rounded mb-4">
                    <h1 className="h4 mb-0">نظام إدارة الدرجات - جمعية بناء</h1>
                </header>
            );
        }

        // مكون عرض الدرجات
function GradesViewer() {
    const [loading, setLoading] = React.useState(false);
    const [error, setError] = React.useState(null);
    const [grades, setGrades] = React.useState(null);
    // إضافة حالة للقوائم المنسدلة
    const [batches, setBatches] = React.useState([]);
    const [subjects, setSubjects] = React.useState([]);
    const [selectedBatch, setSelectedBatch] = React.useState('');

    // دالة لجلب قائمة الدفعات
    const fetchBatches = async () => {
        try {
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getBatches();
            });
            setBatches(result);
        } catch (err) {
            setError('خطأ في جلب قائمة الدفعات: ' + err.message);
        }
    };

    // دالة لجلب المواد بناءً على الدفعة المختارة
    const fetchSubjects = async (batchName) => {
        if (!batchName) {
            setSubjects([]);
            return;
        }
        try {
            const result = await new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                    .getSubjects(batchName);
            });
            setSubjects(result);
        } catch (err) {
            setError('خطأ في جلب قائمة المواد: ' + err.message);
        }
    };

    // جلب الدفعات عند تحميل المكون
    React.useEffect(() => {
        fetchBatches();
    }, []);

    // جلب المواد عند تغيير الدفعة
    React.useEffect(() => {
        fetchSubjects(selectedBatch);
    }, [selectedBatch]);

    return (
        <div className="card">
            <div className="card-header">
                عرض الدرجات
            </div>
            <div className="card-body">
                <form className="row g-3 mb-4" onSubmit={(e) => {
                    e.preventDefault();
                    const subject = e.target.subjectCode.value;
                    if (selectedBatch && subject) {
                        fetchGrades(selectedBatch, subject);
                    }
                }}>
                    <div className="col-md-5">
                        <label className="form-label">الدفعة</label>
                        <select 
                            name="batchName" 
                            className="form-select" 
                            required
                            value={selectedBatch}
                            onChange={(e) => setSelectedBatch(e.target.value)}
                        >
                            <option value="">اختر الدفعة...</option>
                            {batches.map(batch => (
                                <option key={batch.batchName} value={batch.batchName}>
                                    {batch.batchName}
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="col-md-5">
                        <label className="form-label">المادة</label>
                        <select 
                            name="subjectCode" 
                            className="form-select" 
                            required
                            disabled={!selectedBatch}
                        >
                            <option value="">اختر المادة...</option>
                            {subjects.map(subject => (
                                <option key={subject.subjectCode} value={subject.subjectCode}>
                                    {subject.subjectName} ({subject.level})
                                </option>
                            ))}
                        </select>
                    </div>
                    <div className="col-md-2 d-flex align-items-end">
                        <button 
                            type="submit" 
                            className="btn btn-primary w-100"
                            disabled={!selectedBatch || subjects.length === 0}
                        >
                            عرض
                        </button>
                    </div>
                </form>

                {/* عرض رسائل الخطأ */}
                {error && (
                    <div className="alert alert-danger">
                        {error}
                    </div>
                )}

                {/* عرض حالة التحميل */}
                {loading && (
                    <div className="text-center p-4">
                        <div className="spinner-border text-primary" role="status">
                            <span className="visually-hidden">جاري التحميل...</span>
                        </div>
                        <p className="mt-2">جاري جلب البيانات...</p>
                    </div>
                )}

                {/* عرض الدرجات */}
                {grades && !loading && (
                    <div className="table-responsive">
                        <table className="table table-striped">
                            <thead>
                                <tr>
                                    <th>الطالب</th>
                                    <th>المشاركة</th>
                                    <th>الحضور</th>
                                    <th>التمارين</th>
                                    <th>القراءة</th>
                                    <th>الاختبار</th>
                                    <th>المجموع</th>
                                    <th>التقدير</th>
                                </tr>
                            </thead>
                            <tbody>
                                {grades.map(grade => (
                                    <tr key={grade.studentId}>
                                        <td>{grade.fullName}</td>
                                        <td>{grade.participationGrade}</td>
                                        <td>{grade.attendanceGrade}</td>
                                        <td>{grade.exerciseGrade}</td>
                                        <td>{grade.readingGrade}</td>
                                        <td>{grade.testGrade}</td>
                                        <td>{grade.totalGrade}</td>
                                        <td>{grade.grade}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </div>
        </div>
    );
}

        // المكون الرئيسي
        function App() {
            return (
                <div className="container py-4">
                    <Header />
                    <GradesViewer />
                </div>
            );
        }

        // تشغيل التطبيق
        ReactDOM.render(
            <App />,
            document.getElementById('root')
        );
    </script>
</body>
</html>
